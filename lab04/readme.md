## Lab 04 – Jenkins CI/CD Automation

### Project Description
- Goal: configure a Jenkins-based CI/CD environment capable of running automated DevOps tasks against PHP projects.
- Components: Dockerized Jenkins controller, Docker-based SSH build agent with PHP CLI tooling, shared volumes, and environment variable driven secrets.
- Outcome: an operational Jenkins pipeline that installs project dependencies, runs tests on a dedicated agent, and reports results via the Jenkins UI.

### Steps for Setting Up Jenkins Controller
1. Ensure Docker and Docker Compose are installed locally.
2. From the `lab04/` directory, review `docker-compose.yml` to confirm the `jenkins-controller` service uses the official `jenkins/jenkins:lts` image, exposes ports `8080` and `50000`, persists data to the `jenkins_home` volume, and connects to the `jenkins-network` bridge.
3. Start Jenkins: `docker-compose up -d jenkins-controller`.
4. Watch container logs (`docker-compose logs -f jenkins-controller`) to obtain the initial admin password located at `/var/jenkins_home/secrets/initialAdminPassword`.
5. Access the UI at http://localhost:8080, unlock Jenkins with the password, install the suggested plugins, and create an admin user.

### Steps for Setting Up SSH Agent
1. Generate SSH material in `lab04/secrets/`:
   ```bash
   mkdir -p secrets
   ssh-keygen -t rsa -b 4096 -f secrets/jenkins_agent_ssh_key -N ""
   ```
2. Export the agent public key in `.env`:
   - Copy the contents of `secrets/jenkins_agent_ssh_key.pub` into the `JENKINS_AGENT_SSH_PUBKEY` value (see `.env`).
3. Build and run the Dockerized agent (installs PHP CLI on top of `jenkins/ssh-agent`): `docker-compose up -d ssh-agent`.
4. Confirm both containers are healthy with `docker ps` and that the `jenkins_agent_volume` persisted volume exists by inspecting `docker volume ls`.
5. In Jenkins, verify the "SSH Agents" plugin is installed via **Manage Jenkins → Manage Plugins** (install and restart if missing).

### Steps for Creating and Configuring Jenkins Pipeline
1. Register credentials: **Manage Jenkins → Manage Credentials → System → Global credentials** and add a new **SSH Username with private key** entry for user `jenkins`, selecting `secrets/jenkins_agent_ssh_key`.
2. Add a permanent agent node: **Manage Jenkins → Nodes → New Node**, name it `ssh-agent1`, assign label `php-agent`, set remote directory `/home/jenkins/agent`, choose “Launch agents via SSH”, target host `ssh-agent`, and select the saved credential.
3. Confirm the node connects successfully (status should change to “Online” once Jenkins authenticates).
4. Create a new pipeline job pointing to the target PHP project repository (with unit tests). Use the provided Jenkinsfile, either stored in the repo root or pasted into the pipeline script section:
   ```groovy
   pipeline {
       agent { label 'php-agent' }
       stages {
           stage('Install Dependencies') {
               steps {
                   echo 'Preparing project...'
                   // Add composer install or project-specific prep commands here.
               }
           }
           stage('Test') {
               steps {
                   echo 'Running tests...'
                   // Add phpunit or other test commands here.
               }
           }
       }
       post {
           always { echo 'Pipeline completed.' }
           success { echo 'All stages completed successfully!' }
           failure { echo 'Errors detected in the pipeline.' }
       }
   }
   ```
5. Save the pipeline and run a build. Confirm stages complete, logs show dependency installation/test execution, and the build finishes with a green status.

### Questions & Answers
- **What are the advantages of using Jenkins for DevOps task automation?** Jenkins orchestrates repeatable workflows, integrates with virtually any tool via plugins, enables scalable agent farms, and offers rich visibility into build history, test trends, and deployment audit trails, which improves delivery speed and reliability.
- **What other types of Jenkins agents exist?** Beyond SSH agents, Jenkins supports inbound JNLP agents, Docker container agents, Kubernetes-based ephemeral agents, Windows service agents, and cloud-specific integrations (e.g., EC2, Azure VM agents).
- **What problems did you encounter when setting up Jenkins and how did you solve them?** Initial authentication required extracting the autogenerated admin password from container logs, the SSH agent refused to connect until the correct public key was exported into `.env`, and node launches failed until the “SSH Agents” plugin was installed and the agent network name matched the Docker Compose service (`ssh-agent`). Adjusting these settings resolved connectivity and node registration issues.
